<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
   
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <title>Responsive User Task Form</title>
    <style>
        /* General Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body Style */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
        }

        /* Heading */
        h1 {
            text-align: center;
            color: #4CAF50;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        /* Form */
        form {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            padding: 20px;
        }

        /* Form Group */
        .form-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        label {
            font-size: 16px;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
            flex: 1;
            min-width: 150px;
        }

        input[type="text"], input[type="date"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            color: #555;
            flex: 2;
        }

        input[type="text"]:focus, input[type="date"]:focus {
            border-color: #4CAF50;
            outline: none;
        }

        /* Required Fields */
        .required {
            color: red;
            font-weight: bold;
        }

        /* Buttons (Submit and Cancel) */
        .form-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        input[type="submit"], .cancel-btn {
            width: 48%;
            padding: 12px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            text-align: center;
        }

        input[type="submit"] {
            background-color: #4CAF50;
            color: white;
            border: none;
        }

        input[type="submit"]:hover {
            background-color: #45a049;
        }

        .cancel-btn {
            background-color: #f44336;
            color: white;
            border: none;
        }

        .cancel-btn:hover {
            background-color: #e53935;
        }


        /* Note for Required Fields */
        .note {
            margin-top: 15px;
            font-size: 14px;
            color: red;
            text-align: center;
        }
        select {
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 16px;
    color: #555;
    flex: 2;
}

select:focus {
    border-color: #4CAF50;
    outline: none;
}
/* Popup Message Style */
.popup {
            display: none;
            padding: 20px;
            font-size: 16px;
            border-radius: 8px;
            text-align: center;
            width: 100%;
            max-width: 400px;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
        }

        /* Green Popup for Success */
        .popup.success {
            background-color: #4CAF50;
            color: white;
        }

        /* Red Popup for Failure */
        .popup.failure {
            background-color: #f44336;
            color: white;
        }


   
  .image-map-btn-custom:hover {
      background-color: #0d0e0e;
  }
  
  /* Initially hide the image map container */
  .image-map-container {
      display: none;
      margin-top: 5px;
      margin-bottom: 15px;
      width: 100%;
      max-width: 700px; /* Adjust as needed */
      height: 500px;
      border: 2px solid #ccc;
      border-radius: 8px;
      overflow: hidden;
  }
  
  .image-map-container iframe {
      width: 100%;
      height: 100%;
      border: none;
      overflow: auto;
      
  }
  .pile-container {
    text-align: center;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      border-width: 10px;
      border-radius: 3px;
      border-color: #080808;
  }
  
  .pile-tag {
      background-color: #007bff;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 14px;
      display: flex;
      align-items: center;
  }
  
  .remove-x {
      margin-left: 8px;
      cursor: pointer;
      font-weight: bold;
      color: rgb(0, 0, 0);
  }
  
  .remove-x:hover {
      color: #d61111;
  }
  .custom-dropdown {
        position: relative;
        display: inline-block;
        width: 200px;
    }

    .checkbox-label {
      color: red;
    display: flex;
    align-items: center;
    gap: 8px; 
    cursor: pointer; 
}

.checkbox-label input[type="checkbox"] {
    width: 16px;
    height: 16px;
}
.hotspot-wrapper {
    display: flex;
    align-items: center; 
    gap: 15px; 
    flex-wrap: wrap; 
    justify-content: center;
    width: 100%;
}

/* Styles for the hotspot container */
#hotspotContainer {
    border: 2px solid #ccc; 
    padding: 10px;
    min-width: 200px; 
    height: 80px; /* Use height instead of min/max */
    overflow-y: auto; /* Ensure vertical scrolling */
    overflow-x: hidden; /* Hide horizontal overflow */
    background: #f9f9f9;
    border-radius: 5px;
    margin-bottom: 10px;
}
/* Common styles for buttons */
.image-map-btn-custom {
    display: inline-block;
    padding: 8px 12px;
    background-color: #311f1f;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.3s ease;
    align-self: center;
    margin-bottom: 10px;
    min-width: 120px; /* Ensure proper button size */
}
#loadingSpinner {
    display: none;
    position: fixed;
    top: 50%;
    left: 45%;
    transform: translate(-50%, -50%);
    width: 40px;
    height: 40px;
    border: 4px solid rgba(0, 0, 0, 0.1);
    border-top: 4px solid #0597f8;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    z-index: 1000;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
/* Responsive Behavior */
@media (max-width: 768px) {
    .hotspot-wrapper {
        flex-direction: row; /* Stack items vertically */
        align-items: center; /* Keep centered */
        gap: 10px;
    }

    #hotspotContainer {
        width: 100%; /* Make sure it fits in smaller screens */
        max-width: 90%;
        margin-left: 0px;
    }

    .image-map-btn-custom {
        width: 90%; /* Make buttons take more space */
        max-width: 200px; /* Keep a limit */
        text-align: center;
        margin-right: 0; /* Remove right margin */
    }

    .form-group {
        flex-direction: column;
        width: 100%;
    }

    label {
        margin-bottom: 5px;
    }

    input[type="text"],
    input[type="date"] {
        width: 100%;
    }

    .form-buttons {
        flex-direction: column;
        gap: 10px;
    }

    input[type="submit"],
    .cancel-btn {
        width: 100%;
    }
}

    </style>               
</head>
<body>
    <h1>Create Remedy</h1>
    <form id="remedyForm" action="/submit_remedy_form" method="POST">

        <div class="form-group">
            <label for="area_id">Select Area <span class="required">*</span></label>
            <select id="area_id" name="area_id" required>
                <option value="" disabled selected>Select Area</option>
                <option value="A001">Area 1</option>
                <option value="A002">Area 2</option>
                <option value="A003">Area 3</option>
                <option value="A004">Area 4</option>
                <option value="A005">Area 5</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="user_id">Select User  <span class="required">*</span></label>
            <select id="user_id" name="user_id" required>
                <option value="" disabled selected>Select User</option>
            </select>
        </div>
        <div class="hotspot-wrapper">
          <button type="button" class="image-map-btn-custom" onclick="openImageMap()">Open Map</button>
          <div id="hotspotContainer"></div>
          <button type="button" class="delete-btn" ></button>
      </div>

      <!-- Hidden input to store selected hotspots -->
      <input type="hidden" id="selectedHotspots" name="selectedHotspots">

      <div id="imageMapContainer" class="image-map-container">
          <iframe src="/area1remedyhotspot" id="imageMapFrame"></iframe>
      </div>

        <!--<div class="form-group">
            <label for="pile_id">Select Pile <span class="required">*</span></label>
            <input type="text" id="pile_id" name="pile_id" placeholder="Select pile" required>
        </div>-->

         <!--<div class="form-group">
            <label for="pile_id">Select Table <span class="required">*</span></label>
           <select id="row_id" name="row_id" required>
                <option value="" disabled selected>Select Row</option>
                 Options will be populated dynamically 
            </select>
            <input type="text" id="pile_id" name="pile_id" placeholder="Select From Image Map">
          </div>-->

        <div class="form-group">
            <label for="task_date">Task Date <span class="required">*</span></label>
            <input type="date" id="task_date" name="task_date" required>
        </div>

       <!-- <div class="form-group">
            <label for="assessed_case">Assessed Case <span class="required">*</span></label>
            <input type="text" id="assessed_case" name="assessed_case" placeholder="Enter assessed case" required>
        </div>-->
    
        <div class="form-group">
            <label for="allotted_date">Allotted Date <span class="required">*</span></label>
            <input type="date" id="allotted_date" name="allotted_date" required>
        </div>

        <div class="form-group">
          <label for="allotted_by">Allotted By <span class="required">*</span></label>
          <select id="allotted_by" name="allotted_by" required>
              <option value="" disabled selected>Select</option>
          </select>
      </div>

        <div class="form-group">
            <label for="date_completed">Date Completed <span class="required">*</span></label>
            <input type="date" id="date_completed" name="date_completed" >
        </div>

       <!-- <div class="form-group">
            <label for="remedy_status">Remedy Status</label>
            <input type="text" id="remedy_status" name="remedy_status" placeholder="Enter remedy status">
        </div>-->
        <!--<div class="form-group">
            <label for="remedy_status"
              >Assessment Status<span class="required">*</span></label
            >
            <select id="remedy_status" name="remedy_status" required>
              <option value="Incomplete" selected>Incomplete</option>
              <option value="In progres">In progres </option>
              <option value="Under review">Under Review</option>
              <option value="Final">Final</option>
            </select>
          </div>

          <div class="form-group">
            <label for="assessed_case"
              >Assessed Case<span class="required">*</span></label
            >
            <select id="assessed_case" name="assessed_case" required>
              <option value="None" selected>None</option>
              <option value="Corrosion1">Corrosion1</option>
              <option value="Corrosion2">Corrosion2</option>
              <option value="Corrosion3">Corrosion3</option>
            </select>
          </div>-->
          
        <div class="form-group">
            <label for="remedy_text">Remedy Text</label>
            <input type="text" id="remedy_text" name="remedy_text" placeholder="Enter remedy text">
        </div>

        <div class="form-buttons">
            <button type="button" class="cancel-btn" onclick="window.location.href='/dashboard'">Cancel</button>
            <input type="submit" value="Submit">
            <div id="loadingSpinner"></div>
        </div>
        
        <p class="note">* Required</p>
    </form>

     <!-- Popup message for success or failure -->
     <div id="popupMessage" class="popup"></div>

     <script>
      let selectedPiles = [];

// Load users from backend
fetch("/get_user_ids")
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const userSelect = document.getElementById("user_id");
            const allotedBySelect = document.getElementById("allotted_by");
            data.users.forEach(user => {
                let userOption = new Option(user.username, user.id);
                userSelect.add(userOption);
                let allotedByOption = new Option(user.username, user.id);
                allotedBySelect.add(allotedByOption);
            });
        } else {
            alert("Failed to load users: " + data.message);
        }
    })
    .catch(error => console.error("Error fetching users:", error));

    function updateSelectedHotspots() {
    setTimeout(() => {
        selectedPiles = Array.from(document.querySelectorAll(".hotspot-checkbox:checked"))
            .map(cb => cb.value);

        document.getElementById("selectedHotspots").value = selectedPiles.join(",");
        console.log("Updated Selected Hotspots (Unchecked Only):", selectedPiles);
    }, 10);
}
window.addHotspotToDropdown = function (hotspotName) {
    if (selectedPiles.includes(hotspotName)) return;

    selectedPiles.push(hotspotName);
    updateSelectedHotspots();

    let label = document.createElement("label");
    label.style.display = "block";

    let checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.value = hotspotName;
    checkbox.classList.add("hotspot-checkbox");
    checkbox.checked = true;
    checkbox.addEventListener("change", updateSelectedHotspots);

    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(" " + hotspotName));

    document.getElementById("hotspotContainer").appendChild(label);
};

window.removeHotspotFromDropdown = function (hotspotName) {
    selectedPiles = selectedPiles.filter(pile => pile !== hotspotName);
    updateSelectedHotspots();

    let checkbox = document.querySelector(`input[value='${hotspotName}']`);
    if (checkbox) {
        checkbox.parentElement.remove();
    }
};

function openImageMap() {
    let container = document.getElementById("imageMapContainer");
    let button = document.querySelector(".image-map-btn-custom");

    if (container.style.display === "none" || container.style.display === "") {
        container.style.display = "block";
        button.textContent = "Close Map";
    } else {
        container.style.display = "none";
        button.textContent = "Open Map";
    }
}
document.querySelector(".delete-btn").addEventListener("click", function () {
    let checkboxes = document.querySelectorAll(".hotspot-checkbox");
    
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            checkbox.parentElement.remove(); // Remove label and checkbox
        }
    });

    // Update selected hotspots after deletion
    updateSelectedHotspots();
});
      // dont give prvs dates
      const today = new Date().toISOString().split("T")[0];
      // Set the min attribute to today's date
      document.getElementById("task_date").setAttribute("min", today);
       // Handling form submission
       document.getElementById('remedyForm').addEventListener('submit', function(event) {
    event.preventDefault(); // Prevent default form submission

    // Create a FormData object to send the form data via fetch
    var formData = new FormData(this);

    // Fetch request to submit form data
    fetch('/submit_remedy_form', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        var popupMessage = document.getElementById('popupMessage');

        // Dynamically display server message
        popupMessage.textContent = data.message || 'Error submitting the form. Please try again.';

        if (data.success) {
            // Display success popup and redirect
            popupMessage.classList.remove('failure');
            popupMessage.classList.add('success');

            // Redirect after 3 seconds
            setTimeout(function() {
                window.location.href = 'dashboard';
            }, 3000);
        } else {
            // Display failure popup and stay on the page
            popupMessage.classList.remove('success');
            popupMessage.classList.add('failure');
        }

        // Show popup message
        popupMessage.style.display = 'block';

        // Hide popup after 3 seconds
        setTimeout(function() {
            popupMessage.style.display = 'none';
        }, 3000);
    })
    .catch(error => {
        var popupMessage = document.getElementById('popupMessage');
        popupMessage.classList.remove('success');
        popupMessage.classList.add('failure');
        popupMessage.textContent = 'There was an error submitting the form. Please try again.';
        popupMessage.style.display = 'block';

        // Hide popup after 3 seconds
        setTimeout(function() {
            popupMessage.style.display = 'none';
        }, 2000);
    });
});
     </script>
</body>
</html>
